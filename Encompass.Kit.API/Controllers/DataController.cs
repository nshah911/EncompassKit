using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Impac.Encompass.Kit.API.Controllers
{
    [RoutePrefix("api/data")]
    public class DataController : ApiController
    {
        protected readonly string _encompassInstance = System.Configuration.ConfigurationManager.AppSettings["EncompassInstance"];
        protected readonly string _encompassUserName = System.Configuration.ConfigurationManager.AppSettings["EncompassUserName"];
        protected readonly string _encompassPassword = System.Configuration.ConfigurationManager.AppSettings["EncompassPassword"];
        protected readonly string _encompassKey = System.Configuration.ConfigurationManager.AppSettings["EncompassKey"];
        protected readonly string _filesBasePath = System.Configuration.ConfigurationManager.AppSettings["FilesBasePath"];

        ILogger _Logger = LogManager.GetLogger("Encompass.Kit.API");
        IDataService _dataService = new DataService();

        [HttpGet]
        [Route("health")]
        public IHttpActionResult Health()
        {
            return Ok("Service is up");
        }

        [HttpPost]
        [Route("creditfiles")]
        public IHttpActionResult GetCreditFiles(GetCreditFilesRequest getCreditFilesRequest)
        {
            var getCreditFilesResponse = new GetCreditFilesResponse();

            try
            {
                using (EllieMae.Encompass.Client.Session session = new EllieMae.Encompass.Client.Session())
                {
                    session.Start(_encompassInstance, _encompassUserName, _encompassPassword);

                    var loan = session.Loans.Open("{" + getCreditFilesRequest.LoanGuid.ToString() + "}");

                    if (loan == null) return NotFound();

                    loan.Export($"{_filesBasePath}DU32_{getCreditFilesRequest.LoanGuid}.FNM", _encompassKey, LoanExportFormat.FNMA32);

                    getCreditFilesResponse.DU32 = $"{_filesBasePath}DU32_{getCreditFilesRequest.LoanGuid}.FNM";

                    var result = _dataService.GetCreditContents(session, loan);
                    for (int i = 0; i < result.Count; i++)
                    {
                        File.WriteAllText($"{_filesBasePath}credit_{getCreditFilesRequest.LoanGuid}_{i + 1}.xml", result[i].Content);
                        var creditFileDto = new CreditFileDto
                        {
                            FileLocation = $"{_filesBasePath}credit_{getCreditFilesRequest.LoanGuid}_{i + 1}.xml"
                        };

                        XmlDocument xDoc = new XmlDocument();
                        xDoc.LoadXml(result[i].Content);

                        var creditResponseNode = xDoc.DocumentElement.SelectSingleNode("/RESPONSE_GROUP/RESPONSE/RESPONSE_DATA/CREDIT_RESPONSE");
                        string creditReferenceId = creditResponseNode.Attributes["CreditReportIdentifier"].Value;

                        creditFileDto.BorrowerPair = getCreditFilesRequest.BorrowerPairs.FirstOrDefault(b => b.CreditReferenceId == creditReferenceId);

                        getCreditFilesResponse.BorrowerPairs.Add(creditFileDto);
                    }
                    loan.Close();

                    return Ok(getCreditFilesResponse);
                }
            }
            catch (Exception ex)
            {
                _Logger.Error(ex, $"Error getting credit files for {getCreditFilesRequest.LoanGuid}");
                return InternalServerError(ex);
            }
        }

        [HttpPost]
        [Route("uploadfnmfile")]
        public IHttpActionResult UploadFNMFile(AddFNMFileRequest addFNMFileRequest)
        {
            try
            {
                _dataService.UploadFNMFile(addFNMFileRequest.LoanGuid, addFNMFileRequest.FilePath, _encompassInstance, _encompassUserName, _encompassPassword);
                return Ok(addFNMFileRequest);
            }
            catch (FileNotFoundException ex)
            {
                _Logger.Error(ex, $"Error uplading DU3.2 file {addFNMFileRequest.FilePath} for loan {addFNMFileRequest.LoanGuid}");
                return NotFound();
            }
            catch (LoanLockedException ex)
            {
                _Logger.Error(ex, $"Error uplading DU3.2 file {addFNMFileRequest.FilePath} for loan {addFNMFileRequest.LoanGuid}");
                return Content(HttpStatusCode.Conflict, ex.Message);
            }
            catch (Exception ex)
            {
                _Logger.Error(ex, $"Error uplading DU3.2 file {addFNMFileRequest.FilePath} for loan {addFNMFileRequest.LoanGuid}");
                return InternalServerError(ex);
            }
        }

        [HttpGet]
        [Route("UploadIUSEligibilityData")]
        public IHttpActionResult UploadIUSEligibilityData() //--IUSEligibilityDataRequest iusDataRequest)
        {
            //-------------------------------------------------------------------------------------------------------
            // This call is used just to test the API without going through the full route of "hangfire" by calling
            // localhost:<port#>/api/data/UploadIUSEligibilityData
            //-------------------------------------------------------------------------------------------------------

            try
            {
                // Loan# in 8910: TEST001885
                string strLoanGuid = "{43bb15ab-04f3-443f-a015-398601b38bc9}";
                string htmlContent =
"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\" style=\"font-family:  Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;\">\r\n    <head>\r\n        <meta name=\"viewport\" content=\"width=device-width\" />\r\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\r\n        <title>AUS Cert</title>\r\n        <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\" />\r\n        <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css\" />\r\n        <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js\"></script>\r\n        <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js\"></script>\r\n        <style>\r\n            hr {\r\n                display: block;\r\n                margin-top: 0;\r\n                margin-bottom: 0.5em;\r\n                border-style: inset;\r\n                border-width: 3px;\r\n                color: lightgrey;\r\n                width: 100%\r\n            }\r\n            section{\r\n                padding-bottom: 30px;\r\n            }\r\n\r\n            .col-4, .col-5, .col-6, .col-7{\r\n                padding-left: 5px !important;\r\n                padding-right: 5px !important;\r\n            }\r\n            \r\n            table{\r\n                width: 100%;\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div class=\"container\">\r\n            <div class=\"row align-items-end\" style=\"text-align: center;\">\r\n\r\n                <table>\r\n                    <tr>\r\n                        <td>\r\n                            <img class=\"img-fluid py-2\" src=\"https://impacwebcdnprod.azureedge.net/IUS/assets/ImpacLogo.jpg\" style=\"width:250px;height:auto; margin-top: 30px; \" />\r\n                        </td>\r\n                        <td valign=\"bottom\">\r\n                            <h3 class=\"py-3\"><b>NQM ELIGIBILITY CERT</b></h3>\r\n                        </td>\r\n                        <td valign=\"bottom\">\r\n                                    <img class=\"img-fluid\" src=\"https://impacwebcdnprod.azureedge.net/IUS/assets/Ineligible.png\" />\r\n                        </td>\r\n                    </tr>\r\n                </table>\r\n            </div>\r\n\r\n            <section class=\"row px-3\">\r\n                <hr />\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Borrower Name</b></td>\r\n                            <td>sonny graves</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Co-Borrower Name</b></td>\r\n                            <td>Second Borrower</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Property Street</b></td>\r\n                            <td>1600 s douglass rd</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>City State Zip</b></td>\r\n                            <td>Anaheim CA 92806</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Loan Number</b></td>\r\n                            <td>TEST001885</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Submission Date</b></td>\r\n                            <td>03/13/2020</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Submission No.</b></td>\r\n                            <td>266</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        BASIC ELIGIBILITY CRITERIA\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td></td>\r\n                        </tr>\r\n\r\n                        <tr>\r\n                            <td><b>Loan Program</b></td>\r\n                            <td>Bankstatement Premier</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Loan Amount</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Loan Purpose</b></td>\r\n                            <td>Purchase</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Property Type</b></td>\r\n                            <td>Attached</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>No Of Units</b></td>\r\n                            <td>One Unit</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>DSCR</b></td>\r\n                            <td>0.0</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td></td>\r\n                        </tr>\r\n\r\n                        <tr>\r\n                            <td><b>LTV/CLTV/HCLTV</b></td>\r\n                            <td>0 / 0 / 0</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Housing/Debt Ratio</b></td>\r\n                            <td>7.94 / 8.10</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Occupancy</b></td>\r\n                            <td>Investment</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>FICO</b></td>\r\n                            <td>330</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Credit Event</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        LOAN DETAILS\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-4\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Appraised Value</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Sales Price</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Amortization Type</b></td>\r\n                            <td>Undefined</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-3\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Note Rate</b></td>\r\n                            <td>0.0%</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Qual Rate</b></td>\r\n                            <td>0.0%</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Term</b></td>\r\n                            <td>0</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Rate Lock</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Rate Lock Expiration</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Appraisal Required</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        ASSET DETAILS\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-7\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Submitted Reserves</b></td>\r\n                            <td>0</td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Required Reserves(Mo.)</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Eligible Gift Funds</b></td>\r\n                            <td>$0.00</td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Eligible C/O Reserves</b></td>\r\n                            <td>N/A</td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Total Funds Required</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Funds Available</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Cash-Out</b></td>\r\n                            <td>0</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Cash-In-Hand</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        HOUSING INFORMATION\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-7\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Proposed P&amp;I Qualifying Payment</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Hazard Insurance/Taxes</b></td>\r\n                            <td>$75.00    /    $100.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>HOA/Other</b></td>\r\n                            <td>$0.00    /    $0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Housing Payments</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Impounds Required</b></td>\r\n                            <td>No</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Negative Net Rental</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Subject Neg. Cash Flow</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>All Other Payments</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Expense Payments</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Present Housing Payment</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        INCOME DETAILS\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-7\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Base Income</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>OverTime Income</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Bonus</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Commission</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Other</b></td>\r\n                            <td> / </td>\r\n                            <td> / </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Positive Net Rental</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Subj. Positive Cash Flow</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Income</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Residual Income To Be Verified</b></td>\r\n                                    <td>No</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Residual Income Required</b></td>\r\n                                    <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n                <p>\r\n                    <b>\r\n                        ELIGIBILITY FAILURE REASON:\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <section>\r\n                    <div class=\"row\">\r\n                        <div class=\"col-12\">\r\n                            <ul>\r\n                                <li>\r\n                                    <h5>Credit Score &gt;= 680.</h5>\r\n                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n        <section class=\"row px-3\">\r\n            <p>\r\n                <b>\r\n                    CONDITIONS:\r\n                </b>\r\n            </p>\r\n            <hr />\r\n            <div class=\"row\">\r\n                <div class=\"col-auto\">\r\n<!-- ## conditions ## -->                </div>\r\n            </div>\r\n                        <p class=\"pt-4\">\r\n                                <b>\r\n                                    Broker Conditions\r\n                                </b>\r\n                        </p>\r\n                    <table class=\"table table-striped\">\r\n                        <tr>\r\n                            <th style=\"width: 10%\">Condition ID</th>\r\n                            <th style=\"width: 55%\">Description</th>\r\n                            <th style=\"width: 10%\">Category</th>\r\n                            <th style=\"width: 15%\">Responsible Party</th>\r\n                            <th style=\"width: 10%\">Prior To</th>\r\n                        </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">AP01</td>\r\n                                    <td>Initial loan application to be signed and dated by the borrower(s), the LO signed on (___)</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">B01</td>\r\n                                    <td>Broker to provide fully completed final doc order request and all applicable invoices including: credit, IBTS, 3rd party processing and appraisal. </td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">D56</td>\r\n                                    <td>Fully executed Impac Intent to Proceed</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">S92</td>\r\n                                    <td>Escrow/Closing Agent to provide their Business License ID # in order to prepare the borrower(s) initial CD.</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PR01</td>\r\n                                    <td>680 Min FICO, Max DTI 43%, 0x30x24, Min 4 years since major derog (BK, Foreclosure, Short Sale, Deed in lieu)</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PR03</td>\r\n                                    <td>Minimum DSCR 1.25 (1.15 if loan application date on or after 2/10/20)</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">A09</td>\r\n                                    <td>[$$$] of usable assets is required to close and reserves. Verified assets in file ($$$$) </td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">AQ14</td>\r\n                                    <td>Copy of [LoanData.EarnestMoneyDeposit,C] Earnest Money Deposit (EMD) and proof of receipt from escrow/holder of the deposit.  Document that EMD is sourced and seasoned for the last 2 months, and has been cleared from borrower&#39;s account.</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PR02</td>\r\n                                    <td>6 months reserves (cannot be waived), Cash out proceeds may not be used</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">H01</td>\r\n                                    <td>Provide hazard insurance with replacement cost, borrower name, property address and loss payee.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">T02</td>\r\n                                    <td>Title Commitment with 24 months title history for subject property and most recent year tax bill.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">CQ05</td>\r\n                                    <td>Updated VOM for all mortgages through month of close</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">CQ41</td>\r\n                                    <td>Complete REO with all PITIA (mortgage statement, tax, Insurance &amp; HOA for all properties owned)</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">CQ20</td>\r\n                                    <td>Provide signed explanation for the following inquiries reflecting on the credit report in the past 120 days verifying no undisclosed debt. Each inquiry must be addressed separately.</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ11</td>\r\n                                    <td>Borrower must document two years current continuous self-employment for the following business(es) with business license or statement from independent 3rd party i.e., tax preparer, CPA, accountant confirming the same, and the borrowers % of ownership.</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ41</td>\r\n                                    <td>Verbal VOE to be performed by Impac within 10 business days prior to note date.</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">SQ15</td>\r\n                                    <td>Estimated ALTA Settlement Statement to include all taxes, credits, fees, impounds (if applicable) and pro-rations (if applicable)</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">T07</td>\r\n                                    <td>Fully executed purchase contract including all Addendums and Counter Offers showing [this.LoanData.SalesPrice,C] purchase price.  </td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">DQ01</td>\r\n                                    <td>The borrower must acknowledge their ability to repay the loan by signing the Borrower Affirmation document at closing.</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">T03</td>\r\n                                    <td>Provide CURRENT Closing Protection Letter specific to this transaction from title including E&amp;O Insurance.</td>\r\n                                    <td style=\"text-align: center\">Tile</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">S03</td>\r\n                                    <td>If for any reason this loan does not close within 72 hours of your receipt of funds, immediately return all documents to Lender and wire all funds only to Warehouse Lender</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                    </table>\r\n                        <p class=\"pt-4\">\r\n                                <b>\r\n                                    Internal Conditions\r\n                                </b>\r\n                        </p>\r\n                    <table class=\"table table-striped\">\r\n                        <tr>\r\n                            <th style=\"width: 10%\">Condition ID</th>\r\n                            <th style=\"width: 55%\">Description</th>\r\n                            <th style=\"width: 10%\">Category</th>\r\n                            <th style=\"width: 15%\">Responsible Party</th>\r\n                            <th style=\"width: 10%\">Prior To</th>\r\n                        </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">Q01</td>\r\n                                    <td>Prefunding QC audit</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">I21</td>\r\n                                    <td>Internal VOD - income qualifying acct</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">P29</td>\r\n                                    <td>Life of Loan Flood Certificate.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">P01</td>\r\n                                    <td>Appraisal (Property Type), including acceptable form 1007 (if required) with AIR certificate and SSR required for loan amount ($$).</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PQ43</td>\r\n                                    <td>Satisfactory review of ARR desk review to support value. Underwriter to order.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">C01</td>\r\n                                    <td>Soft Pull /Refresh credit report to show no additional liabilities or inquires within 14 days of closing</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">N07</td>\r\n                                    <td>Account Manager/Purchaser to run final LoanSafe report to include all parties for the LDP/GSA/OFAC/FHLMC Exclusionary search, final MERS and validate no changes to the same.</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ53</td>\r\n                                    <td>Provide a CPA or tax preparer produced letter to verify business expense factor</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">SQ33</td>\r\n                                    <td>Max seller financing contribution allowed is _% or actual closing costs whichever is less.</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">AP02</td>\r\n                                    <td>Final corrected &amp; typed 1003 signed by all borrowers and Loan Officers (Note: Impac to provide these items with loan docs.)</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">Funder</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ28</td>\r\n                                    <td>Verbal VOE to be performed by Impac within 10 business days prior to Note date.</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Funder</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">S40</td>\r\n                                    <td>Cash to close cannot exceed ($$$)</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">NQ22</td>\r\n                                    <td>Seller credit not to exceed</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">C20</td>\r\n                                    <td> Copy of unexecuted deed of trust</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                    </table>\r\n\r\n        </section>\r\n\r\n        </div>\r\n\r\n        <script src=\"https://code.jquery.com/jquery-3.3.1.slim.min.js\" integrity=\"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo\" crossorigin=\"anonymous\"></script>\r\n        <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js\" integrity=\"sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1\" crossorigin=\"anonymous\"></script>\r\n        <script src=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js\" integrity=\"sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM\" crossorigin=\"anonymous\"></script>\r\n    </body>\r\n</html>\r\n";

                //_dataService.UploadIUSEligibilityData(iusDataRequest.LoanGuid, iusDataRequest.HtmlContent, _encompassInstance, _encompassUserName, _encompassPassword);
                _dataService.UploadIUSEligibilityData(strLoanGuid, htmlContent, _encompassInstance, _encompassUserName, _encompassPassword);
                //return Ok(iusDataRequest);
                return Ok();
            }
            catch (FileNotFoundException ex)
            {
                //_Logger.Error(ex, $"Error uplading IUS Eligibility html data for loan {iusDataRequest.LoanGuid}");
                return NotFound();
            }
            catch (LoanLockedException ex)
            {
                //_Logger.Error(ex, $"Error uplading IUS Eligibility html data for loan {iusDataRequest.LoanGuid}");
                return Content(HttpStatusCode.Conflict, ex.Message);
            }
            catch (Exception ex)
            {
                //_Logger.Error(ex, $"Error uplading IUS Eligibility html data for loan {iusDataRequest.LoanGuid}");
                return InternalServerError(ex);
            }
        }

        [HttpPost]
        [Route("UploadIUSEligibilityData")]
        public IHttpActionResult UploadIUSEligibilityData(IUSEligibilityDataRequest iusDataRequest)
        {
            try
            {
                //                // Loan# in 8910: TEST001885
                //                string strLoanGuid = "{43bb15ab-04f3-443f-a015-398601b38bc9}";
                //                string htmlContent =
                //"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\" style=\"font-family:  Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;\">\r\n    <head>\r\n        <meta name=\"viewport\" content=\"width=device-width\" />\r\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\r\n        <title>AUS Cert</title>\r\n        <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\" />\r\n        <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css\" />\r\n        <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js\"></script>\r\n        <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js\"></script>\r\n        <style>\r\n            hr {\r\n                display: block;\r\n                margin-top: 0;\r\n                margin-bottom: 0.5em;\r\n                border-style: inset;\r\n                border-width: 3px;\r\n                color: lightgrey;\r\n                width: 100%\r\n            }\r\n            section{\r\n                padding-bottom: 30px;\r\n            }\r\n\r\n            .col-4, .col-5, .col-6, .col-7{\r\n                padding-left: 5px !important;\r\n                padding-right: 5px !important;\r\n            }\r\n            \r\n            table{\r\n                width: 100%;\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div class=\"container\">\r\n            <div class=\"row align-items-end\" style=\"text-align: center;\">\r\n\r\n                <table>\r\n                    <tr>\r\n                        <td>\r\n                            <img class=\"img-fluid py-2\" src=\"https://impacwebcdnprod.azureedge.net/IUS/assets/ImpacLogo.jpg\" style=\"width:250px;height:auto; margin-top: 30px; \" />\r\n                        </td>\r\n                        <td valign=\"bottom\">\r\n                            <h3 class=\"py-3\"><b>NQM ELIGIBILITY CERT</b></h3>\r\n                        </td>\r\n                        <td valign=\"bottom\">\r\n                                    <img class=\"img-fluid\" src=\"https://impacwebcdnprod.azureedge.net/IUS/assets/Ineligible.png\" />\r\n                        </td>\r\n                    </tr>\r\n                </table>\r\n            </div>\r\n\r\n            <section class=\"row px-3\">\r\n                <hr />\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Borrower Name</b></td>\r\n                            <td>sonny graves</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Co-Borrower Name</b></td>\r\n                            <td>Second Borrower</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Property Street</b></td>\r\n                            <td>1600 s douglass rd</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>City State Zip</b></td>\r\n                            <td>Anaheim CA 92806</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Loan Number</b></td>\r\n                            <td>TEST001885</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Submission Date</b></td>\r\n                            <td>03/13/2020</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Submission No.</b></td>\r\n                            <td>266</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        BASIC ELIGIBILITY CRITERIA\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td></td>\r\n                        </tr>\r\n\r\n                        <tr>\r\n                            <td><b>Loan Program</b></td>\r\n                            <td>Bankstatement Premier</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Loan Amount</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Loan Purpose</b></td>\r\n                            <td>Purchase</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Property Type</b></td>\r\n                            <td>Attached</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>No Of Units</b></td>\r\n                            <td>One Unit</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>DSCR</b></td>\r\n                            <td>0.0</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-6\">\r\n                    <table>\r\n                        <tr>\r\n                            <td></td>\r\n                        </tr>\r\n\r\n                        <tr>\r\n                            <td><b>LTV/CLTV/HCLTV</b></td>\r\n                            <td>0 / 0 / 0</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Housing/Debt Ratio</b></td>\r\n                            <td>7.94 / 8.10</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Occupancy</b></td>\r\n                            <td>Investment</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>FICO</b></td>\r\n                            <td>330</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Credit Event</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        LOAN DETAILS\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-4\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Appraised Value</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Sales Price</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Amortization Type</b></td>\r\n                            <td>Undefined</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-3\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Note Rate</b></td>\r\n                            <td>0.0%</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Qual Rate</b></td>\r\n                            <td>0.0%</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Term</b></td>\r\n                            <td>0</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Rate Lock</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Rate Lock Expiration</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Appraisal Required</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        ASSET DETAILS\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-7\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Submitted Reserves</b></td>\r\n                            <td>0</td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Required Reserves(Mo.)</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Eligible Gift Funds</b></td>\r\n                            <td>$0.00</td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Eligible C/O Reserves</b></td>\r\n                            <td>N/A</td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Total Funds Required</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Funds Available</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Cash-Out</b></td>\r\n                            <td>0</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Cash-In-Hand</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        HOUSING INFORMATION\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-7\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Proposed P&amp;I Qualifying Payment</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Hazard Insurance/Taxes</b></td>\r\n                            <td>$75.00    /    $100.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>HOA/Other</b></td>\r\n                            <td>$0.00    /    $0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Housing Payments</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Impounds Required</b></td>\r\n                            <td>No</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Negative Net Rental</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Subject Neg. Cash Flow</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>All Other Payments</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Expense Payments</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Present Housing Payment</b></td>\r\n                            <td>$0.00</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n            <section class=\"row px-3\">\r\n                <p>\r\n                    <b>\r\n                        INCOME DETAILS\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <div class=\"col-7\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Base Income</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>OverTime Income</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Bonus</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Commission</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Other</b></td>\r\n                            <td> / </td>\r\n                            <td> / </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total</b></td>\r\n                            <td></td>\r\n                            <td></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                <div class=\"col-5\">\r\n                    <table>\r\n                        <tr>\r\n                            <td><b>Positive Net Rental</b></td>\r\n                            <td>N/A</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Subj. Positive Cash Flow</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Total Income</b></td>\r\n                            <td></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Residual Income To Be Verified</b></td>\r\n                                    <td>No</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td><b>Residual Income Required</b></td>\r\n                                    <td>N/A</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </section>\r\n\r\n                <p>\r\n                    <b>\r\n                        ELIGIBILITY FAILURE REASON:\r\n                    </b>\r\n                </p>\r\n                <hr />\r\n                <section>\r\n                    <div class=\"row\">\r\n                        <div class=\"col-12\">\r\n                            <ul>\r\n                                <li>\r\n                                    <h5>Credit Score &gt;= 680.</h5>\r\n                                </li>\r\n                            </ul>\r\n                        </div>\r\n                    </div>\r\n                </section>\r\n        <section class=\"row px-3\">\r\n            <p>\r\n                <b>\r\n                    CONDITIONS:\r\n                </b>\r\n            </p>\r\n            <hr />\r\n            <div class=\"row\">\r\n                <div class=\"col-auto\">\r\n<!-- ## conditions ## -->                </div>\r\n            </div>\r\n                        <p class=\"pt-4\">\r\n                                <b>\r\n                                    Broker Conditions\r\n                                </b>\r\n                        </p>\r\n                    <table class=\"table table-striped\">\r\n                        <tr>\r\n                            <th style=\"width: 10%\">Condition ID</th>\r\n                            <th style=\"width: 55%\">Description</th>\r\n                            <th style=\"width: 10%\">Category</th>\r\n                            <th style=\"width: 15%\">Responsible Party</th>\r\n                            <th style=\"width: 10%\">Prior To</th>\r\n                        </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">AP01</td>\r\n                                    <td>Initial loan application to be signed and dated by the borrower(s), the LO signed on (___)</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">B01</td>\r\n                                    <td>Broker to provide fully completed final doc order request and all applicable invoices including: credit, IBTS, 3rd party processing and appraisal. </td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">D56</td>\r\n                                    <td>Fully executed Impac Intent to Proceed</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">S92</td>\r\n                                    <td>Escrow/Closing Agent to provide their Business License ID # in order to prepare the borrower(s) initial CD.</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PR01</td>\r\n                                    <td>680 Min FICO, Max DTI 43%, 0x30x24, Min 4 years since major derog (BK, Foreclosure, Short Sale, Deed in lieu)</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PR03</td>\r\n                                    <td>Minimum DSCR 1.25 (1.15 if loan application date on or after 2/10/20)</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">A09</td>\r\n                                    <td>[$$$] of usable assets is required to close and reserves. Verified assets in file ($$$$) </td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">AQ14</td>\r\n                                    <td>Copy of [LoanData.EarnestMoneyDeposit,C] Earnest Money Deposit (EMD) and proof of receipt from escrow/holder of the deposit.  Document that EMD is sourced and seasoned for the last 2 months, and has been cleared from borrower&#39;s account.</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PR02</td>\r\n                                    <td>6 months reserves (cannot be waived), Cash out proceeds may not be used</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">H01</td>\r\n                                    <td>Provide hazard insurance with replacement cost, borrower name, property address and loss payee.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">T02</td>\r\n                                    <td>Title Commitment with 24 months title history for subject property and most recent year tax bill.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">CQ05</td>\r\n                                    <td>Updated VOM for all mortgages through month of close</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">CQ41</td>\r\n                                    <td>Complete REO with all PITIA (mortgage statement, tax, Insurance &amp; HOA for all properties owned)</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">CQ20</td>\r\n                                    <td>Provide signed explanation for the following inquiries reflecting on the credit report in the past 120 days verifying no undisclosed debt. Each inquiry must be addressed separately.</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ11</td>\r\n                                    <td>Borrower must document two years current continuous self-employment for the following business(es) with business license or statement from independent 3rd party i.e., tax preparer, CPA, accountant confirming the same, and the borrowers % of ownership.</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ41</td>\r\n                                    <td>Verbal VOE to be performed by Impac within 10 business days prior to note date.</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">SQ15</td>\r\n                                    <td>Estimated ALTA Settlement Statement to include all taxes, credits, fees, impounds (if applicable) and pro-rations (if applicable)</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">T07</td>\r\n                                    <td>Fully executed purchase contract including all Addendums and Counter Offers showing [this.LoanData.SalesPrice,C] purchase price.  </td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">DQ01</td>\r\n                                    <td>The borrower must acknowledge their ability to repay the loan by signing the Borrower Affirmation document at closing.</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">T03</td>\r\n                                    <td>Provide CURRENT Closing Protection Letter specific to this transaction from title including E&amp;O Insurance.</td>\r\n                                    <td style=\"text-align: center\">Tile</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">S03</td>\r\n                                    <td>If for any reason this loan does not close within 72 hours of your receipt of funds, immediately return all documents to Lender and wire all funds only to Warehouse Lender</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                    </table>\r\n                        <p class=\"pt-4\">\r\n                                <b>\r\n                                    Internal Conditions\r\n                                </b>\r\n                        </p>\r\n                    <table class=\"table table-striped\">\r\n                        <tr>\r\n                            <th style=\"width: 10%\">Condition ID</th>\r\n                            <th style=\"width: 55%\">Description</th>\r\n                            <th style=\"width: 10%\">Category</th>\r\n                            <th style=\"width: 15%\">Responsible Party</th>\r\n                            <th style=\"width: 10%\">Prior To</th>\r\n                        </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">Q01</td>\r\n                                    <td>Prefunding QC audit</td>\r\n                                    <td style=\"text-align: center\">1003/Misc</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">I21</td>\r\n                                    <td>Internal VOD - income qualifying acct</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">P29</td>\r\n                                    <td>Life of Loan Flood Certificate.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">P01</td>\r\n                                    <td>Appraisal (Property Type), including acceptable form 1007 (if required) with AIR certificate and SSR required for loan amount ($$).</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">PQ43</td>\r\n                                    <td>Satisfactory review of ARR desk review to support value. Underwriter to order.</td>\r\n                                    <td style=\"text-align: center\">Collateral</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">C01</td>\r\n                                    <td>Soft Pull /Refresh credit report to show no additional liabilities or inquires within 14 days of closing</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">N07</td>\r\n                                    <td>Account Manager/Purchaser to run final LoanSafe report to include all parties for the LDP/GSA/OFAC/FHLMC Exclusionary search, final MERS and validate no changes to the same.</td>\r\n                                    <td style=\"text-align: center\">Credit</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ53</td>\r\n                                    <td>Provide a CPA or tax preparer produced letter to verify business expense factor</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">SQ33</td>\r\n                                    <td>Max seller financing contribution allowed is _% or actual closing costs whichever is less.</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTD</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">AP02</td>\r\n                                    <td>Final corrected &amp; typed 1003 signed by all borrowers and Loan Officers (Note: Impac to provide these items with loan docs.)</td>\r\n                                    <td style=\"text-align: center\">Broker</td>\r\n                                    <td style=\"text-align: center\">Funder</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">IQ28</td>\r\n                                    <td>Verbal VOE to be performed by Impac within 10 business days prior to Note date.</td>\r\n                                    <td style=\"text-align: center\">Income</td>\r\n                                    <td style=\"text-align: center\">Funder</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">S40</td>\r\n                                    <td>Cash to close cannot exceed ($$$)</td>\r\n                                    <td style=\"text-align: center\">Assets</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">NQ22</td>\r\n                                    <td>Seller credit not to exceed</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style=\"text-align: center\">C20</td>\r\n                                    <td> Copy of unexecuted deed of trust</td>\r\n                                    <td style=\"text-align: center\">Title</td>\r\n                                    <td style=\"text-align: center\">Lender</td>\r\n                                    <td style=\"text-align: center\">PTF</td>\r\n                                </tr>\r\n                    </table>\r\n\r\n        </section>\r\n\r\n        </div>\r\n\r\n        <script src=\"https://code.jquery.com/jquery-3.3.1.slim.min.js\" integrity=\"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo\" crossorigin=\"anonymous\"></script>\r\n        <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js\" integrity=\"sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1\" crossorigin=\"anonymous\"></script>\r\n        <script src=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js\" integrity=\"sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM\" crossorigin=\"anonymous\"></script>\r\n    </body>\r\n</html>\r\n";

                _dataService.UploadIUSEligibilityData(iusDataRequest.LoanGuid, iusDataRequest.HtmlContent, _encompassInstance, _encompassUserName, _encompassPassword);
                return Ok(iusDataRequest);
            }
            catch (FileNotFoundException ex)
            {
                _Logger.Error(ex, $"loan not found {iusDataRequest.LoanGuid}");
                return NotFound();
            }
            catch (LoanLockedException ex)
            {
                _Logger.Error(ex, $"loan locked during efolder IUS Eligibility html data for loan {iusDataRequest.LoanGuid}");
                return Content(HttpStatusCode.Conflict, ex.Message);
            }
            catch (Exception ex)
            {
                _Logger.Error(ex, $"Error uplading IUS Eligibility html data for loan {iusDataRequest.LoanGuid}");
                return InternalServerError(ex);
            }
        }

        [HttpGet]
        [Route("GetLoanGuidByLoanNumber")]
        public IHttpActionResult GetLoanGuidByLoanNumber(string loannumber)
        {
            try
            {
                using (EllieMae.Encompass.Client.Session session = new EllieMae.Encompass.Client.Session())
                {
                    session.Start(_encompassInstance, _encompassUserName, _encompassPassword);

                    string loanGuid = GetLoanGuid(loannumber, session);

                    //if (string.IsNullOrEmpty(loanGuid))
                    //    return NotFound();

                    return Ok(loanGuid);
                }
            }
            catch (Exception ex)
            {
                _Logger.Error(ex, $"Error getting GetLoanGuidByLoanNumber {loannumber}");
                return InternalServerError(ex);
            }
        }

        [HttpGet]
        [Route("GetLoanGuidByLenderCaseNumber")]
        public IHttpActionResult GetLoanGuidByLenderCaseNumber(string loannumber)
        {
            try
            {
                EllieMae.Encompass.BusinessObjects.DataObject dataObject = new EllieMae.Encompass.BusinessObjects.DataObject(file);

                // Create a new attachment by importing it from a TIFF document on disk
                Attachment att = ln.Attachments.AddObject(dataObject, fileExtension);
                att.Title = name;

                LogEntryList documents = ln.Log.TrackedDocuments.GetDocumentsByTitle(title);

                if (documents.Count == 0)
                {
                    //Creating title
                    ln.Log.TrackedDocuments.Add(title, ln.Log.MilestoneEvents.NextEvent.MilestoneName);
                    documents = ln.Log.TrackedDocuments.GetDocumentsByTitle(title);
                }

                // Create a new attachment by importing it from disk
                TrackedDocument document = (TrackedDocument)documents[0];
                document.Attach(att);

                using (EllieMae.Encompass.Client.Session session = new EllieMae.Encompass.Client.Session())
                {
                    session.Start(_encompassInstance, _encompassUserName, _encompassPassword);

                    string loanGuid = GetLoanGuid(loannumber, session, true);

                    //if (string.IsNullOrEmpty(loanGuid))
                    //    return NotFound();

                    return Ok(loanGuid);
                }
            }
            catch (Exception ex)
            {
                _Logger.Error(ex, $"Error getting GetLoanGuidByLenderCaseNumber {loannumber}");
                return InternalServerError(ex);
            }
        }

        private string GetLoanGuid(string encompassLoanNumber, EllieMae.Encompass.Client.Session session, bool basedOnLenderCaseNum = false)
        {
            //-----------------------------------------------------------------------------------------
            // Finding a loan guid: If lender case number is set to true, will query based off of lender case number,
            // otherwise by encompass loan number
            //-----------------------------------------------------------------------------------------

            string loanGuid = string.Empty;

            string ENCOMPASS_LOAN_NUMBER = "Fields.364";
            string LENDER_CASE_NUM_ENCOMPASS_FIELD_NAME = "Fields.305";
            //string SELLER_NUMBER_STORED_ENCOMPASS_FIELD_NAME = "Fields.CX.CLD.COMPANYLEGACYID";

            StringList fieldsToRetrieve = new StringList();
            fieldsToRetrieve.Add("Fields.GUID");    // guid
            fieldsToRetrieve.Add("Fields.305");     // Seller loan Number or called Lender Case number in Encompass UI - 1003 page 1
            fieldsToRetrieve.Add("Fields.364");     // Encompass loan Number (not the GUID)
            fieldsToRetrieve.Add("Fields.36");      // first name
            fieldsToRetrieve.Add("Fields.37");      // last name
            fieldsToRetrieve.Add("Fields.65");      // ssn
            fieldsToRetrieve.Add("Fields.MS.STATUSDATE"); // Last Finished Milestone Date
            fieldsToRetrieve.Add("Fields.UWC.PTA"); // UW Cond. Prior To Approval
            //fieldsToRetrieve.Add("Fields.UWC.ALL"); // UW Cond. All

            List<StringFieldCriterion> strCriterionList = new List<StringFieldCriterion>();
            StringFieldCriterion sfc = null;
            QueryCriterion filter = null;

            // Using Encompass Loan number as query
            if (basedOnLenderCaseNum == false)
            {
                if ((sfc = SetStringCriterion(ENCOMPASS_LOAN_NUMBER, encompassLoanNumber, StringFieldMatchType.Exact, true)) != null)
                    strCriterionList.Add(sfc);
            }
            else // based off of lender case number
            {
                // Using lender case number as query
                if ((sfc = SetStringCriterion(LENDER_CASE_NUM_ENCOMPASS_FIELD_NAME, encompassLoanNumber, StringFieldMatchType.Exact, true)) != null)
                    strCriterionList.Add(sfc);
            }

            //// Add org seller number to the query also (so "lender case number" and "Org Seller number" both togther must be unique in Encompass).
            //if ((sfc = SetStringCriterion(SELLER_NUMBER_STORED_ENCOMPASS_FIELD_NAME, orgSellerNumber, StringFieldMatchType.Contains, true)) != null)
            //    strCriterionList.Add(sfc);

            foreach (StringFieldCriterion c in strCriterionList)
            {
                if (filter == null && c != null)
                    filter = c;
                else if (filter != null && c != null)
                    filter.And(c);
            }

            LoanReportCursor results = session.Reports.OpenReportCursor(fieldsToRetrieve, filter);
            if (results.Count > 0)      // as long there is a count > 0, implies a record exists with the combination of "Lender Case Num", "Org Seller number".
            {
                // Get just the first loan item's in the list. Get its EncompassLoanNumber and pass it for cheking in the Encompass client if the business wants to see.
                foreach (LoanReportData loanData in results)
                {
                    encompassLoanNumber = loanData["Fields.364"].ToString();
                    loanGuid = loanData["Fields.GUID"].ToString();
                    break;
                }
            }

            results.Close();        // close the report cursor result.
            return loanGuid;
        }

        private StringFieldCriterion SetStringCriterion(string field,
            string value, StringFieldMatchType matchType, bool inlcude)
        {
            StringFieldCriterion sfc = null;
            if (value.Length > 0)
                sfc = new StringFieldCriterion(field, value, matchType, inlcude);

            return sfc;
        }



    }
}
